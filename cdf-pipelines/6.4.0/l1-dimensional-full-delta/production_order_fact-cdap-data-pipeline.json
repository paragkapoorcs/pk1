{
    "name": "production_order_fact",
    "description": "production order fact",
    "artifact": {
        "name": "cdap-data-pipeline",
        "version": "6.4.0",
        "scope": "SYSTEM"
    },
    "config": {
        "resources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "driverResources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "connections": [
            {
                "from": "Merge Statement",
                "to": "Update Audit Table"
            }
        ],
        "comments": [],
        "postActions": [],
        "properties": {},
        "processTimingEnabled": true,
        "stageLoggingEnabled": false,
        "stages": [
            {
                "name": "Merge Statement",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Merge Statement",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.17.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO `${ProjectID}.${TargetDatasetNames1}.production_order_fact` tgt\nUSING (WITH tmp_scr AS (SELECT\n  po.order_number || '-' || COALESCE(mpp.order_item_number,'') as production_order_key,\n  po.order_number,\n  po.order_type,\n  po.company_code,\n  po.created_on,\n  po.change_date_for_order_master,\n  mpd.material_number,\n  mpd.plant,\n  mpd.maintenance_status,\n  mpd.plant_level_deletion_flag,\n  mpd.valuation_category,\n  mpd.batch_management_indicator,\n  mpd.plant_specific_material_status,\n  mpd.valid_from,\n  mpd.abc_indicator,\n  mpd.critical_part,\n  mpd.purchasing_group,\n  mpd.unit_of_issue,\n  mpd.mrp_profile,\n  mpd.mrp_type,\n  mpd.mrp_controller_buyer,\n  mpd.planned_deliv_time,\n  mpd.goods_receipt_processing_time,\n  mpd.period_indicator,\n  mpd.assembly_scrap,\n  mpd.lot_sizing_procedure,\n  mpd.procurement_type,\n  mpd.special_procurement_type,\n  mpd.dependent_requirements_indicator,\n  mpd.storage_costs_code,\n  mpd.selection_method,\n  mpd.discontinuation_indicator,\n  mpd.effective_out_date,\n  mpd.follow_up_material,\n  mpd.requirements_group,\n  mpd.mixed_mrp_indicator,\n  mpd.scheduling_margin_key,\n  mpd.automatic_fixing_planned_orders,\n  mpd.automatic_release,\n  mpd.backflush,\n  mpd.processing_time,\n  mpd.setup_time,\n  mpd.interoperation_time,\n  mpd.in_house_production,\n  mpd.maximum_storage_period,\n  mpd.time_unit,\n  mpd.withdrawal_production_bin,\n  mpd.rough_cut_planning,\n  mpd.overdelivery_tolerance_limit,\n  mpd.unlimited_overdelivery_allowed,\n  mpd.underdely_tolerance,\n  mpd.total_replenishment_lead_time,\n  mpd.replacement_part,\n  mpd.surcharge_factor_percent,\n  mpd.state_of_manufacture,\n  mpd.stock_type,\n  mpd.sample_percentage,\n  mpd.quarantine_period,\n  mpd.qm_control_key,\n  mpd.mean_inspection_duration,\n  mpd.inspection_plan_indicator,\n  mpd.documentation_required,\n  mpd.active_substance,\n  mpd.inspection_interval,\n  mpd.next_inspection,\n  mpd.loading_group,\n  mpd.batch_management_requirement,\n  mpd.quota_arrangement_usage,\n  mpd.service_level,\n  mpd.splitting_indicator,\n  mpd.plan_version,\n  mpd.object_type,\n  mpd.object_id,\n  mpd.availability_check,\n  mpd.fiscal_year_variant,\n  mpd.correction_factors,\n  mpd.shipping_setup_time,\n  mpd.shipping_processing_time,\n  mpd.delivery_cycle,\n  mpd.source_of_supply,\n  mpd.automatic_purchase_order,\n  mpd.source_list,\n  mpd.commodity_code,\n  mpd.country_of_origin,\n  mpd.region_of_origin,\n  mpd.commodity_code_unit,\n  mpd.intrastat_material_group,\n  mpd.planning_calendar,\n  mpd.repetitive_manufacturing,\n  mpd.planning_time_fence,\n  mpd.consumption_mode,\n  mpd.backward_consumption_period,\n  mpd.forward_consumption_period,\n  mpd.version_indicator,\n  mpd.alternative_bom,\n  mpd.bom_usage,\n  mpd.task_list_group,\n  mpd.group_counter,\n  mpd.special_procurement_costing,\n  mpd.production_unit,\n  mpd.production_storage_location,\n  mpd.mrp_group,\n  mpd.component_scrap,\n  mpd.certificate_type,\n  mpd.inspection_setup,\n  mpd.takt_time,\n  mpd.coverage_profile,\n  mpd.local_field_name,\n  mpd.physical_inventory_indicator,\n  mpd.variance_key,\n  mpd.serial_number_profile,\n  mpd.internal_object_number,\n  mpd.configurable_material,\n  mpd.repetitive_manufacturing_profile,\n  mpd.negative_stocks,\n  mpd.target_qm_system,\n  mpd.planning_cycle,\n  mpd.rounding_profile,\n  mpd.reference_material_for_consumption,\n  mpd.reference_plant_for_consumption,\n  mpd.date_of_material,\n  mpd.multiplier_for_reference_material,\n  mpd.reset_automatically,\n  mpd.customs_preference,\n  mpd.exemption_certificate,\n  mpd.exemption_certificate_number,\n  mpd.issue_date_certificate,\n  mpd.vendor_declaration_code,\n  mpd.vendor_declaration_date,\n  mpd.military_goods,\n  mpd.isr_service_level,\n  mpd.material_co_product,\n  mpd.planning_strategy_group,\n  mpd.material_internal_object_number,\n  mpd.storage_location_external_procurement,\n  mpd.bulk_material,\n  mpd.cc_indicator_fixed,\n  mpd.withdrawal_sequence_group,\n  mpd.qm_material_authorization,\n  mpd.adjustment_period,\n  mpd.task_list_type,\n  mpd.uom_group,\n  mpd.conversion_group,\n  mpd.air_bouyancy_factor,\n  mpd.production_scheduling_profile,\n  mpd.safety_time_indicator,\n  mpd.safety_time,\n  mpd.action_control,\n  mpd.batch_entry,\n  po.business_area,\n  po.controlling_area,\n  po.responsible_cost_center,\n  po.order_currency,\n  po.profit_center,\n  po.sales_order_number,\n  po.sales_order_item,\n  po.project_definition,\n  po.planner_group,\n  po.wbs_element,\n  po.mrp_controller,\n  po.order_priority,\n  po.created_by,\n  po.order_category,\n  po.location,\n  po.production_supervisor,\n  po.requesting_cost_center,\n  po.last_changed_by,\n  po.scheduling_type,\n  po.customer_number,\n  po.batch_number,\n  po.planning_plant,\n  po.production_version,\n  po.system_status,\n  po.status_object_confirmation,\n  po.status_object_delivered,\n  mpp.delivered,\nmpp.actual_release_date,\nmpp.planned_release_date,\nmpp.scheduled_release_date,\nmpp.actual_finish_date,\nmpp.basic_finish_date,\nmpp.scheduled_finish,\nmpp.actual_start_date,\nmpp.basic_start_date,\nmpp.scheduled_start,\nmpp.leading_order,\nmpp.superior_order,\nmpp.posting_date,\nmpp.unit_execution_time,\nmpp.unit_execution_time_exact,\nmpp.planned_opening_date,\nmpp.actual_scrap_quantity,\nmpp.actual_execution_time,\nmpp.actual_execution_time_exact,\nmpp.actual_lead_time,\nmpp.actual_lead_time_exact,\nmpp.capacity_unit,\nmpp.capacity_requirement,\nmpp.actual_delivery_date,\nmpp.planned_order_delivery_date,\nmpp.base_unit_of_measure,\nmpp.scrap_quantity,\nmpp.planned_order_quantity,\nmpp.planned_actual_scheduled_release_date,\nmpp.planned_actual_scheduled_delivery_date,\nmpp.scheduled_start_date,\nmpp.planned_order,\nmpp.order_item_number,\nmpp.scrap_quantity_item,\nmpp.order_item_quantity,\nmpp.planned_target_release_deviation,\nmpp.planned_target_delivery_deviation,\nmpp.planned_target_start_deviation,\nmpp.planned_lead_time,\nmpp.target_actual_release_deviation,\nmpp.target_actual_delivery_deviation,\nmpp.target_actual_start_deviation,\nmpp.planned_order_planned_start_date,\nmpp.target_execution_time,\nmpp.target_execution_time_exact,\nmpp.target_lead_time,\nmpp.target_lead_time_exact,\nmpp.quantity_of_goods_received,\nmpp.event,\nmpp.leading_material,\nCASE WHEN mpd.dw_last_update_date > po.dw_last_update_date AND mpd.dw_last_update_date > mpp.dw_last_update_date \n     THEN mpd.dw_last_update_date\n     WHEN po.dw_last_update_date > mpd.dw_last_update_date AND po.dw_last_update_date > mpp.dw_last_update_date \n     THEN po.dw_last_update_date\n     ELSE mpp.dw_last_update_date\n  END AS input_last_update_date,\n  po.dw_active_indicator,\n  md.material_uuid,\n  pd.plant_uuid,\n  cd.customer_uuid,\n  (mpd.material_number || '-' || mpd.plant) as material_key,\n  mpd.plant as plant_key,\n  po.customer_number as customer_key\nFROM  `${ProjectID}.${StagingDatasetName}.material_plant_data` mpd\n       INNER JOIN `${ProjectID}.${StagingDatasetName}.production_orders` po\n  ON  mpd.material_number = po.material_number\n AND  mpd.plant = po.plant\n AND  po.dw_active_indicator = mpd.dw_active_indicator\n       LEFT JOIN `${ProjectID}.${StagingDatasetName}.material_production_planning` mpp \n  ON mpp.order_number = po.order_number \n and mpp.material_number = po.material_number\n and mpp.plant = po.plant\n and mpp.cancel_data_record = ''\n      LEFT JOIN `${ProjectID}.${TargetDatasetNames2}.material_dimension` md\n  ON md.material_key = (mpd.material_number || '-' || mpd.plant)\n AND md.dw_active_indicator = 'Y' \n      LEFT JOIN `${ProjectID}.${TargetDatasetNames2}.plant_dimension` pd\n  ON pd.plant_key = mpd.plant\n AND pd.dw_active_indicator = 'Y'\n      LEFT JOIN `${ProjectID}.${TargetDatasetNames2}.customer_dimension` cd\n  ON cd.customer_key = po.customer_number\n AND cd.dw_active_indicator = 'Y'\n     LEFT JOIN `${ProjectID}.${StagingDatasetName}.layer1_audit_table` lat\n  ON 1 = 1\n AND lat.table_name = 'production_order_fact' \nWHERE mpd.dw_active_indicator = 'Y'\n AND (mpd.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END\n    OR po.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END\n    OR mpp.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END)),\ntmp_prod AS (SELECT ts.*,\n     TO_HEX(MD5((select string_agg(CAST(col as STRING), ', ' order by offset)\n    from unnest(split(trim(format('%t',(select as struct ts.* except(input_last_update_date))), '()'),', ')) col with offset \n    where not col IS NULL\n    ))) as finalmd5key      \n  from tmp_scr ts)\nSELECT t.production_order_key as production_order_join_key,t.*\n  from tmp_prod t\nUNION ALL \nSELECT NULL as production_order_join_key,t.*\n  from tmp_prod t\n       INNER JOIN `${ProjectID}.${TargetDatasetNames1}.production_order_fact` pof\n    ON  pof.production_order_key =  t.production_order_key \n   AND pof.finalmd5key <> t.finalmd5key\n WHERE pof.dw_active_indicator = 'Y') scr\n  ON  tgt.production_order_key = scr.production_order_join_key\nWHEN MATCHED AND tgt.finalmd5key <> scr.finalmd5key THEN \nUPDATE set tgt.dw_end_date = CURRENT_DATETIME()\n          ,tgt.dw_active_indicator = 'N'\nWHEN NOT MATCHED THEN \nINSERT (production_order_uuid,\nproduction_order_key,\norder_number,\norder_type,\nmaterial_number,\nplant,\nmaterial_uuid,\nplant_uuid,\ncustomer_uuid,\nmaterial_key,\nplant_key,\ncustomer_key,\ncompany_code,\ncreated_on,\nchange_date_for_order_master,\nmaintenance_status,\nplant_level_deletion_flag,\nvaluation_category,\nbatch_management_indicator,\nplant_specific_material_status,\nvalid_from,\nabc_indicator,\ncritical_part,\npurchasing_group,\nunit_of_issue,\nmrp_profile,\nmrp_type,\nmrp_controller_buyer,\nplanned_deliv_time,\ngoods_receipt_processing_time,\nperiod_indicator,\nassembly_scrap,\nlot_sizing_procedure,\nprocurement_type,\nspecial_procurement_type,\ndependent_requirements_indicator,\nstorage_costs_code,\nselection_method,\ndiscontinuation_indicator,\neffective_out_date,\nfollow_up_material,\nrequirements_group,\nmixed_mrp_indicator,\nscheduling_margin_key,\nautomatic_fixing_planned_orders,\nautomatic_release,\nbackflush,\nprocessing_time,\nsetup_time,\ninteroperation_time,\nin_house_production,\nmaximum_storage_period,\ntime_unit,\nwithdrawal_production_bin,\nrough_cut_planning,\noverdelivery_tolerance_limit,\nunlimited_overdelivery_allowed,\nunderdely_tolerance,\ntotal_replenishment_lead_time,\nreplacement_part,\nsurcharge_factor_percent,\nstate_of_manufacture,\nstock_type,\nsample_percentage,\nquarantine_period,\nqm_control_key,\nmean_inspection_duration,\ninspection_plan_indicator,\ndocumentation_required,\nactive_substance,\ninspection_interval,\nnext_inspection,\nloading_group,\nbatch_management_requirement,\nquota_arrangement_usage,\nservice_level,\nsplitting_indicator,\nplan_version,\nobject_type,\nobject_id,\navailability_check,\nfiscal_year_variant,\ncorrection_factors,\nshipping_setup_time,\nshipping_processing_time,\ndelivery_cycle,\nsource_of_supply,\nautomatic_purchase_order,\nsource_list,\ncommodity_code,\ncountry_of_origin,\nregion_of_origin,\ncommodity_code_unit,\nintrastat_material_group,\nplanning_calendar,\nrepetitive_manufacturing,\nplanning_time_fence,\nconsumption_mode,\nbackward_consumption_period,\nforward_consumption_period,\nversion_indicator,\nalternative_bom,\nbom_usage,\ntask_list_group,\ngroup_counter,\nspecial_procurement_costing,\nproduction_unit,\nproduction_storage_location,\nmrp_group,\ncomponent_scrap,\ncertificate_type,\ninspection_setup,\ntakt_time,\ncoverage_profile,\nlocal_field_name,\nphysical_inventory_indicator,\nvariance_key,\nserial_number_profile,\ninternal_object_number,\nconfigurable_material,\nrepetitive_manufacturing_profile,\nnegative_stocks,\ntarget_qm_system,\nplanning_cycle,\nrounding_profile,\nreference_material_for_consumption,\nreference_plant_for_consumption,\ndate_of_material,\nmultiplier_for_reference_material,\nreset_automatically,\ncustoms_preference,\nexemption_certificate,\nexemption_certificate_number,\nissue_date_certificate,\nvendor_declaration_code,\nvendor_declaration_date,\nmilitary_goods,\nisr_service_level,\nmaterial_co_product,\nplanning_strategy_group,\nmaterial_internal_object_number,\nstorage_location_external_procurement,\nbulk_material,\ncc_indicator_fixed,\nwithdrawal_sequence_group,\nqm_material_authorization,\nadjustment_period,\ntask_list_type,\nuom_group,\nconversion_group,\nair_bouyancy_factor,\nproduction_scheduling_profile,\nsafety_time_indicator,\nsafety_time,\naction_control,\nbatch_entry,\nbusiness_area,\ncontrolling_area,\nresponsible_cost_center,\norder_currency,\nprofit_center,\nsales_order_number,\nsales_order_item,\nproject_definition,\nplanner_group,\nwbs_element,\nmrp_controller,\norder_priority,\ncreated_by,\norder_category,\nlocation,\nproduction_supervisor,\nrequesting_cost_center,\nlast_changed_by,\nscheduling_type,\ncustomer_number,\nbatch_number,\nplanning_plant,\nproduction_version,\nsystem_status,\nstatus_object_confirmation,\nstatus_object_delivered,\ndelivered,\nactual_release_date,\nplanned_release_date,\nscheduled_release_date,\nactual_finish_date,\nbasic_finish_date,\nscheduled_finish,\nactual_start_date,\nbasic_start_date,\nscheduled_start,\nleading_order,\nsuperior_order,\nposting_date,\nunit_execution_time,\nunit_execution_time_exact,\nplanned_opening_date,\nactual_scrap_quantity,\nactual_execution_time,\nactual_execution_time_exact,\nactual_lead_time,\nactual_lead_time_exact,\ncapacity_unit,\ncapacity_requirement,\nactual_delivery_date,\nplanned_order_delivery_date,\nbase_unit_of_measure,\nscrap_quantity,\nplanned_order_quantity,\nplanned_actual_scheduled_release_date,\nplanned_actual_scheduled_delivery_date,\nscheduled_start_date,\nplanned_order,\norder_item_number,\nscrap_quantity_item,\norder_item_quantity,\nplanned_target_release_deviation,\nplanned_target_delivery_deviation,\nplanned_target_start_deviation,\nplanned_lead_time,\ntarget_actual_release_deviation,\ntarget_actual_delivery_deviation,\ntarget_actual_start_deviation,\nplanned_order_planned_start_date,\ntarget_execution_time,\ntarget_execution_time_exact,\ntarget_lead_time,\ntarget_lead_time_exact,\nquantity_of_goods_received,\nevent,\nleading_material,\ninput_last_update_date,\nfinalmd5key,\ndw_active_indicator,\ndw_start_date,\ndw_end_date,\ndw_last_update_date)\nVALUES (TO_HEX(MD5(production_order_key)),\nscr.production_order_key,\nscr.order_number,\nscr.order_type,\nscr.material_number,\nscr.plant,\nscr.material_uuid,\nscr.plant_uuid,\nscr.customer_uuid,\nscr.material_key,\nscr.plant_key,\nscr.customer_key,\nscr.company_code,\nscr.created_on,\nscr.change_date_for_order_master,\nscr.maintenance_status,\nscr.plant_level_deletion_flag,\nscr.valuation_category,\nscr.batch_management_indicator,\nscr.plant_specific_material_status,\nscr.valid_from,\nscr.abc_indicator,\nscr.critical_part,\nscr.purchasing_group,\nscr.unit_of_issue,\nscr.mrp_profile,\nscr.mrp_type,\nscr.mrp_controller_buyer,\nscr.planned_deliv_time,\nscr.goods_receipt_processing_time,\nscr.period_indicator,\nscr.assembly_scrap,\nscr.lot_sizing_procedure,\nscr.procurement_type,\nscr.special_procurement_type,\nscr.dependent_requirements_indicator,\nscr.storage_costs_code,\nscr.selection_method,\nscr.discontinuation_indicator,\nscr.effective_out_date,\nscr.follow_up_material,\nscr.requirements_group,\nscr.mixed_mrp_indicator,\nscr.scheduling_margin_key,\nscr.automatic_fixing_planned_orders,\nscr.automatic_release,\nscr.backflush,\nscr.processing_time,\nscr.setup_time,\nscr.interoperation_time,\nscr.in_house_production,\nscr.maximum_storage_period,\nscr.time_unit,\nscr.withdrawal_production_bin,\nscr.rough_cut_planning,\nscr.overdelivery_tolerance_limit,\nscr.unlimited_overdelivery_allowed,\nscr.underdely_tolerance,\nscr.total_replenishment_lead_time,\nscr.replacement_part,\nscr.surcharge_factor_percent,\nscr.state_of_manufacture,\nscr.stock_type,\nscr.sample_percentage,\nscr.quarantine_period,\nscr.qm_control_key,\nscr.mean_inspection_duration,\nscr.inspection_plan_indicator,\nscr.documentation_required,\nscr.active_substance,\nscr.inspection_interval,\nscr.next_inspection,\nscr.loading_group,\nscr.batch_management_requirement,\nscr.quota_arrangement_usage,\nscr.service_level,\nscr.splitting_indicator,\nscr.plan_version,\nscr.object_type,\nscr.object_id,\nscr.availability_check,\nscr.fiscal_year_variant,\nscr.correction_factors,\nscr.shipping_setup_time,\nscr.shipping_processing_time,\nscr.delivery_cycle,\nscr.source_of_supply,\nscr.automatic_purchase_order,\nscr.source_list,\nscr.commodity_code,\nscr.country_of_origin,\nscr.region_of_origin,\nscr.commodity_code_unit,\nscr.intrastat_material_group,\nscr.planning_calendar,\nscr.repetitive_manufacturing,\nscr.planning_time_fence,\nscr.consumption_mode,\nscr.backward_consumption_period,\nscr.forward_consumption_period,\nscr.version_indicator,\nscr.alternative_bom,\nscr.bom_usage,\nscr.task_list_group,\nscr.group_counter,\nscr.special_procurement_costing,\nscr.production_unit,\nscr.production_storage_location,\nscr.mrp_group,\nscr.component_scrap,\nscr.certificate_type,\nscr.inspection_setup,\nscr.takt_time,\nscr.coverage_profile,\nscr.local_field_name,\nscr.physical_inventory_indicator,\nscr.variance_key,\nscr.serial_number_profile,\nscr.internal_object_number,\nscr.configurable_material,\nscr.repetitive_manufacturing_profile,\nscr.negative_stocks,\nscr.target_qm_system,\nscr.planning_cycle,\nscr.rounding_profile,\nscr.reference_material_for_consumption,\nscr.reference_plant_for_consumption,\nscr.date_of_material,\nscr.multiplier_for_reference_material,\nscr.reset_automatically,\nscr.customs_preference,\nscr.exemption_certificate,\nscr.exemption_certificate_number,\nscr.issue_date_certificate,\nscr.vendor_declaration_code,\nscr.vendor_declaration_date,\nscr.military_goods,\nscr.isr_service_level,\nscr.material_co_product,\nscr.planning_strategy_group,\nscr.material_internal_object_number,\nscr.storage_location_external_procurement,\nscr.bulk_material,\nscr.cc_indicator_fixed,\nscr.withdrawal_sequence_group,\nscr.qm_material_authorization,\nscr.adjustment_period,\nscr.task_list_type,\nscr.uom_group,\nscr.conversion_group,\nscr.air_bouyancy_factor,\nscr.production_scheduling_profile,\nscr.safety_time_indicator,\nscr.safety_time,\nscr.action_control,\nscr.batch_entry,\nscr.business_area,\nscr.controlling_area,\nscr.responsible_cost_center,\nscr.order_currency,\nscr.profit_center,\nscr.sales_order_number,\nscr.sales_order_item,\nscr.project_definition,\nscr.planner_group,\nscr.wbs_element,\nscr.mrp_controller,\nscr.order_priority,\nscr.created_by,\nscr.order_category,\nscr.location,\nscr.production_supervisor,\nscr.requesting_cost_center,\nscr.last_changed_by,\nscr.scheduling_type,\nscr.customer_number,\nscr.batch_number,\nscr.planning_plant,\nscr.production_version,\nscr.system_status,\nscr.status_object_confirmation,\nscr.status_object_delivered,\nscr.delivered,\nscr.actual_release_date,\nscr.planned_release_date,\nscr.scheduled_release_date,\nscr.actual_finish_date,\nscr.basic_finish_date,\nscr.scheduled_finish,\nscr.actual_start_date,\nscr.basic_start_date,\nscr.scheduled_start,\nscr.leading_order,\nscr.superior_order,\nscr.posting_date,\nscr.unit_execution_time,\nscr.unit_execution_time_exact,\nscr.planned_opening_date,\nscr.actual_scrap_quantity,\nscr.actual_execution_time,\nscr.actual_execution_time_exact,\nscr.actual_lead_time,\nscr.actual_lead_time_exact,\nscr.capacity_unit,\nscr.capacity_requirement,\nscr.actual_delivery_date,\nscr.planned_order_delivery_date,\nscr.base_unit_of_measure,\nscr.scrap_quantity,\nscr.planned_order_quantity,\nscr.planned_actual_scheduled_release_date,\nscr.planned_actual_scheduled_delivery_date,\nscr.scheduled_start_date,\nscr.planned_order,\nscr.order_item_number,\nscr.scrap_quantity_item,\nscr.order_item_quantity,\nscr.planned_target_release_deviation,\nscr.planned_target_delivery_deviation,\nscr.planned_target_start_deviation,\nscr.planned_lead_time,\nscr.target_actual_release_deviation,\nscr.target_actual_delivery_deviation,\nscr.target_actual_start_deviation,\nscr.planned_order_planned_start_date,\nscr.target_execution_time,\nscr.target_execution_time_exact,\nscr.target_lead_time,\nscr.target_lead_time_exact,\nscr.quantity_of_goods_received,\nscr.event,\nscr.leading_material,\nscr.input_last_update_date,\nscr.finalmd5key,\nscr.dw_active_indicator,\nCURRENT_DATETIME(),\nDATETIME(9999, 12, 31, 23, 59, 59),\nCURRENT_DATETIME());",
                        "dialect": "standard",
                        "mode": "batch",
                        "dataset": "${TargetDatasetNames1}",
                        "table": "production_order_fact",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Merge-Statement",
                "type": "action",
                "label": "Merge Statement",
                "icon": "fa-plug"
            },
            {
                "name": "Update Audit Table",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Update Audit Table",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.17.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO \n`${ProjectID}.${StagingDatasetName}.layer1_audit_table` tgt\nUSING ( SELECT \n         'production_order_fact' as table_name\n         ,CASE WHEN (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'production_order_fact') IS NULL\n                    OR (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'production_order_fact') = 'F'\n               THEN 'F'\n               ELSE 'D'\n          END AS full_delta_indicator\n        ,'0PRODORDER_ATTR,0MAT_PLANT_ATTR' as extractors_names\n        ,CAST('1900-01-01T00:00:00' AS DATETIME) as full_load_datetime\n        ,(select max(input_last_update_date) as delta_load_datatime from `${ProjectID}.${TargetDatasetNames1}.production_order_fact`) as delta_load_datetime\n        ,(select COUNT(*) AS inserted_record_count from `${ProjectID}.${TargetDatasetNames1}.production_order_fact` a inner join `${ProjectID}.${StagingDatasetName}.layer1_audit_table` b\n          on 1 = 1 where b.table_name = 'production_order_fact' and  a.dw_last_update_date > CASE WHEN b.full_delta_indicator = 'F' \n                                                                                             THEN b.full_load_datetime\n                                                                                             WHEN b.full_delta_indicator <> 'F'\n                                                                                             THEN b.delta_load_datetime\n                                                                                             ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                                                                        END\n          and a.dw_active_indicator = 'Y') AS inserted_record_count\n        ,CURRENT_DATETIME() as last_update_date\n) scr\non tgt.table_name = scr.table_name\nWHEN MATCHED THEN \nUPDATE set tgt.full_load_datetime ='1900-01-01T00:00:00'\n          ,tgt.delta_load_datetime = scr.delta_load_datetime\n          ,tgt.inserted_record_count = scr.inserted_record_count\n          ,tgt.last_update_date = scr.last_update_date\nWHEN NOT MATCHED THEN\nINSERT (table_name,\n        full_delta_indicator,\n        extractors_names,\n        full_load_datetime,\n        delta_load_datetime,\n        inserted_record_count,\n        last_update_date)\nVALUES(scr.table_name,\n       scr.full_delta_indicator,\n       scr.extractors_names,\n       scr.full_load_datetime,\n       scr.delta_load_datetime,\n       scr.inserted_record_count,\n       scr.last_update_date);",
                        "dialect": "standard",
                        "mode": "batch",
                        "dataset": "${StagingDatasetName}",
                        "table": "layer1_audit_table",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Update-Audit-Table",
                "type": "action",
                "label": "Update Audit Table",
                "icon": "fa-plug"
            }
        ],
        "schedule": "0 * * * *",
        "engine": "spark",
        "numOfRecordsPreview": 100,
        "description": "production order fact",
        "maxConcurrentRuns": 1
    }
}