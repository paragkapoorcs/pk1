{
    "name": "sales_order_fact",
    "description": "sales order fact",
    "artifact": {
        "name": "cdap-data-pipeline",
        "version": "6.5.0",
        "scope": "SYSTEM"
    },
    "config": {
        "resources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "driverResources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "connections": [
            {
                "from": "Merge Statement",
                "to": "Update Audit Table"
            }
        ],
        "comments": [],
        "postActions": [],
        "properties": {},
        "processTimingEnabled": true,
        "stageLoggingEnabled": false,
        "stages": [
            {
                "name": "Merge Statement",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Merge Statement",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.18.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO `${ProjectID}.${TargetDatasetNames2}.sales_order_fact` tgt\nUSING (\nWITH tmp_scr AS (SELECT \n(sdh.sales_document || '-' || sdsl.item_number || '-' ||  sdsl.schedule_line_number) as sales_order_key,\nsdh.sales_document,\nsdsl.item_number,\nsdsl.schedule_line_number,\nsdh.sales_document_type,\nsdh.billing_block,\nsdh.requested_delivery_date,\nsdh.document_currency,\nsdh.number_of_orders,\nsdi.billing_block_1,\nsdi.sd_document_category,\nsdi.gross_weight,\nsdi.application_component,\nsdi.transfer_process,\nsdi.billing_block_2,\nsdi.cumulative_confirmed_quantity_sales_unit,\nsdi.cumulative_confirmed_quantity_base_unit,\nsdi.sales_deal,\nsdi.cumulative_order_quantity,\nsdi.subtotal_1,\nsdi.subtotal_2,\nsdi.subtotal_3,\nsdi.subtotal_4,\nsdi.subtotal_5,\nsdi.subtotal_6,\nsdi.minimum_delivery_quantity,\nsdi.required_delivery_qtuantity,\nsdi.tax_amount,\nsdi.net_order_value,\nsdi.net_weight,\nsdi.special_stock_indicator,\nsdi.unlimited_tolerance,\nsdi.overdelivery_tolerance,\nsdi.underdel_tolerance,\nsdi.reference_document,\nsdi.reference_item,\nsdi.volume,\nsdi.cost_in_document_currency,\nsdi.target_quantity,\nsdi.outline_agreement_target_value,\nsdi.promotion,\nsdi.product_catalog_number,\nsdi.order_items,\nsdi.net_price_sales_quantity,\nsdsl.cancel_data_record,\nsdsl.rejection_status,\nsdsl.incompletion_status_item,\nsdsl.billing_incompletion_status_item,\nsdsl.pricing_incompletion_status_item,\nsdsl.delivery_incompletion_status_item,\nsdsl.confirmed_quantity,\nsdsl.corrected_quantity,\nsdsl.delivery_date,\nsdsl.schedule_line_category,\nsdsl.loading_date,\nsdsl.scheduled_line_blocked,\nsdsl.required_quantity,\nsdsl.material_availability_date,\nsdsl.base_unit_of_measure,\nsdsl.transportation_planning_date,\nsdsl.sales_unit,\nsdsl.goods_issue_date,\nsdsl.desired_delivery_date,\nsdsl.order_quantity,\nsdsl.quotation_valid_from,\nsdsl.order_reason,\nsdsl.quotation_valid_to,\nsdsl.company_code,\nsdsl.billing_block_sd_document,\nsdsl.local_currency,\nsdsl.customer_number,\nsdsl.exchange_rate_type,\nsdsl.customer_group_1,\nsdsl.customer_group_2,\nsdsl.customer_group_3,\nsdsl.customer_group_4,\nsdsl.customer_group_5,\nsdsl.delivery_block,\nsdsl.statistics_currency,\nsdsl.sd_document_category_1,\nsdsl.sales_office,\nsdsl.sales_group,\nsdsl.sales_organization,\nsdsl.distribution_channel,\nsdsl.reason_for_rejection,\nsdsl.changed_on,\nsdsl.order_probability,\nsdsl.batch_number,\nsdsl.credit_data_exchange_rate,\nsdsl.international_article_number,\nsdsl.created_on,\nsdsl.created_by,\nsdsl.billing_block_item,\nsdsl.weight_unit,\nsdsl.condition_unit,\nsdsl.condition_pricing_unit,\nsdsl.storage_location,\nsdsl.material_group,\nsdsl.material_number,\nsdsl.material_entered,\nsdsl.material_group_1,\nsdsl.material_group_2,\nsdsl.material_group_3,\nsdsl.material_group_4,\nsdsl.material_group_5,\nsdsl.net_order_price,\nsdsl.unloading_point_ship_to_party,\nsdsl.bill_to_party,\nsdsl.payer,\nsdsl.ship_to_party,\nsdsl.product_hierarchy,\nsdsl.forwarding_agent,\nsdsl.item_category,\nsdsl.sales_employee,\nsdsl.shipment_route,\nsdsl.division,\nsdsl.statistics_date,\nsdsl.exchange_rate_statistics,\nsdsl.substitution_reason,\nsdsl.denominator,\nsdsl.numerator,\nsdsl.conversion_factor_1,\nsdsl.conversion_factor_2,\nsdsl.update_date_statistics,\nsdsl.sd_document_category_2,\nsdsl.volume_unit,\nsdsl.shipping_point,\nsdsl.document_currency_1,\nsdsl.plant,\nsdsl.target_quantity_uom,\nsdsl.sales_district,\nsdsl.services_rendered_date,\nsdsl.billing_date,\nsdsl.incoterms_part_1,\nsdsl.incoterms_part_2,\nsdsl.customer_group,\nsdsl.account_assignment_group,\nsdsl.exchange_rate,\nsdsl.translation_date,\nsdsl.pricing_date,\nsdsl.document_currency_2,\nsdsl.division_for_order_header,\nsdsl.sales_document_category_reference,\nsdsl.wbs_element,\nsdsl.fiscal_year_variant,\nsdsl.campaign_order_item,\nsdsl.planning_in_apo,\nsdsl.customer_facing_location,\nsdsl.customer_facing_location_type,\nsdsl.executing_location,\nsdsl.executing_location_type,\nsdsl.logical_system,\nsdsl.item_usage,\nsdsl.managing_location,\nsdsl.managing_location_type,\nsld.sales_document as sales_document_shipping,\nsld.picking_confirmation,\nsld.picking_status,\nsld.goods_movement_status,\nsld.schedule_line_date,\nsld.schedule_delivery_block,\nsld.delivered_quantity,\nsld.goods_issue_date_1,\nsld.desired_delete_date,\nsld.unloading_point,\nsld.incterms_1,\nsld.incoterms_2,\nsld.sold_to_party,\nsld.delivery_type,\nsld.vendors_account_number,\nsld.loading_point,\nsld.route,\nsld.actual_goods_movement_date,\nsld.entry_time,\nsld.business_area,\nsld.picking_indicator,\nsld.consumption_posting,\nsld.warehouse_number,\nsld.storage_bin,\nsld.storage_type,\nsld.item_type,\nsld.delivery_item_category,\nsld.denominator_sales_quantity,\nsld.numerator_sales_quantity,\nsld.sales_document_1,\nsld.sales_document_item,\nsld.goods_issue_date_2,\nsld.division_order_header,\nsld.goods_issue_delay,\nsld.actual_goods_issue_delay,\ncoalesce(oid.confirmation_status,ohd.confirmation_status) as confirmation_status,\ncoalesce(oid.billing_status_order_related,ohd.billing_status_order_related) as billing_status_order_related,\noid.billing_status_delivery_related,\ncoalesce(oid.overall_processing_status,ohd.overall_processing_status) as overall_processing_status,\ncoalesce(oid.overall_Deliver_status,ohd.overall_deliver_status) as overall_deliver_status,\ncoalesce(oid.delivery_status,ohd.delivery_status) as delivery_status,\n(sdsl.material_number || '-' || sdsl.plant) as material_key,\nsdsl.plant as plant_key,\nsdsl.customer_number as customer_key,\n(sdsl.customer_number || '-' || sdsl.sales_organization || '-' || sdsl.distribution_channel || '-' || sdsl.division) as customer_sale_org_key,\nsld.vendors_account_number as supplier_key,\nCASE WHEN sdh.dw_last_update_date > sdi.dw_last_update_date and sdh.dw_last_update_date > sdsl.dw_last_update_date and sdh.dw_last_update_date > sld.dw_last_update_date \n     THEN sdh.dw_last_update_date\n     WHEN sdi.dw_last_update_date > sdh.dw_last_update_date and sdi.dw_last_update_date > sdsl.dw_last_update_date and sdi.dw_last_update_date > sld.dw_last_update_date\n     THEN sdi.dw_last_update_date\n     WHEN sdsl.dw_last_update_date > sdh.dw_last_update_date and sdsl.dw_last_update_date > sdi.dw_last_update_date and sdsl.dw_last_update_date > sld.dw_last_update_date\n     THEN sdsl.dw_last_update_date\n     ELSE sld.dw_last_update_date\nEND as input_last_update_date,\nsdsl.dw_active_indicator,\nmd.material_uuid,\npd.plant_uuid,\ncd.customer_uuid,\ncsod.customer_sales_org_uuid,\nsd.supplier_uuid\n FROM `${ProjectID}.${StagingDatasetName}.sales_document_header` sdh \n       INNER JOIN `${ProjectID}.${StagingDatasetName}.sales_document_item` sdi \n    ON sdh.sales_document = sdi.sales_document\n   AND sdi.dw_active_indicator = sdh.dw_active_indicator\n       INNER JOIN `${ProjectID}.${StagingDatasetName}.sales_document_schedule_line` sdsl\n    ON sdsl.sales_document = sdh.sales_document\n   AND sdsl.item_number = sdi.item_number\n   AND sdsl.dw_active_indicator = 'Y'\n       LEFT JOIN `${ProjectID}.${StagingDatasetName}.schedule_line_delivery` sld\n    ON sld.sales_document_1 = sdh.sales_document\n   AND sdi.item_number = sld.item_number\n   AND sdsl.schedule_line_number = sld.schedule_line_number\n   AND sld.dw_active_indicator = 'Y'\n       LEFT JOIN `${ProjectID}.${StagingDatasetName}.layer1_audit_table` lat\n    ON 1 = 1\n   AND lat.table_name = 'sales_order_fact' \n        LEFT JOIN `${ProjectID}.${TargetDatasetNames1}.material_dimension` md\n    ON md.material_key = (sdsl.material_number || '-' || sdsl.plant) \n   AND md.dw_active_indicator = 'Y'\n        LEFT JOIN `${ProjectID}.${TargetDatasetNames1}.plant_dimension` pd\n    ON pd.plant_key = sdsl.plant \n   AND pd.dw_active_indicator = 'Y'\n        LEFT JOIN `${ProjectID}.${TargetDatasetNames1}.customer_dimension` cd\n    ON cd.customer_key = sdsl.customer_number \n   AND cd.dw_active_indicator = 'Y'\n        LEFT JOIN `${ProjectID}.${TargetDatasetNames1}.customer_sales_org_dimension` csod\n    ON csod.customer_sales_org_key = (sdsl.customer_number || '-' || sdsl.sales_organization || '-' || sdsl.distribution_channel || '-' || sdsl.division) \n   AND csod.dw_active_indicator = 'Y'\n        LEFT JOIN `${ProjectID}.${TargetDatasetNames1}.supplier_dimension` sd\n    ON sd.supplier_key = sld.vendors_account_number \n   AND sd.dw_active_indicator = 'Y'\n       LEFT JOIN `${ProjectID}.${StagingDatasetName}.order_header_data` ohd\n    on ohd.sales_document = sdh.sales_document\n   and ohd.dw_active_indicator = 'Y'\n       LEFT JOIN `${ProjectID}.${StagingDatasetName}.order_item_data` oid \n    on oid.sales_document = sdh.sales_document\n   and oid.item_number = sdi.item_number\n   and oid.dw_active_indicator = 'Y'\nwhere sdh.dw_active_indicator = 'Y'\n  AND (sdh.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END\n     OR  sdi.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END\n     OR  sdsl.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END\n    OR  sld.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' \n                                        THEN lat.full_load_datetime\n                                        WHEN lat.full_delta_indicator <> 'F'\n                                        THEN lat.delta_load_datetime\n                                        ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                  END)),\ntmp_sale AS (SELECT ts.*,\n     TO_HEX(MD5((select string_agg(CAST(col as STRING), ', ' order by offset)\n    from unnest(split(trim(format('%t',(select as struct ts.* except(input_last_update_date))), '()'),', ')) col with offset \n    where not col IS NULL\n    ))) as finalmd5key      \n  from tmp_scr ts)\nSELECT t.sales_order_key as sales_order_join_key,t.*\n  from tmp_sale t\nUNION ALL \nSELECT NULL as purchase_order_join_key,t.*\n  from tmp_sale t\n       INNER JOIN `${ProjectID}.${TargetDatasetNames2}.sales_order_fact` sof\n   ON  sof.sales_order_key  = t.sales_order_key\n  AND sof.finalmd5key <> t.finalmd5key\n WHERE sof.dw_active_indicator = 'Y') scr\n    ON tgt.sales_order_key = scr.sales_order_join_key\nWHEN MATCHED  AND tgt.finalmd5key <> scr.finalmd5key  THEN \nUPDATE set tgt.dw_end_date = CURRENT_DATETIME()\n          ,tgt.dw_active_indicator = 'N'\nWHEN NOT MATCHED THEN \nINSERT (\nsales_order_uuid,\nsales_order_key,\nsales_document,\nitem_number,\nschedule_line_number,\nsales_document_type,\nmaterial_uuid,\ncustomer_uuid,\nplant_uuid,\nsupplier_uuid,\ncustomer_sales_org_uuid,\nbilling_block,\nrequested_delivery_date,\ndocument_currency,\nnumber_of_orders,\nbilling_block_1,\nsd_document_category,\ngross_weight,\napplication_component,\ntransfer_process,\nbilling_block_2,\ncumulative_confirmed_quantity_sales_unit,\ncumulative_confirmed_quantity_base_unit,\nsales_deal,\ncumulative_order_quantity,\nsubtotal_1,\nsubtotal_2,\nsubtotal_3,\nsubtotal_4,\nsubtotal_5,\nsubtotal_6,\nminimum_delivery_quantity,\nrequired_delivery_qtuantity,\ntax_amount,\nnet_order_value,\nnet_weight,\nspecial_stock_indicator,\nunlimited_tolerance,\noverdelivery_tolerance,\nunderdel_tolerance,\nreference_document,\nreference_item,\nvolume,\ncost_in_document_currency,\ntarget_quantity,\noutline_agreement_target_value,\npromotion,\nproduct_catalog_number,\norder_items,\nnet_price_sales_quantity,\ncancel_data_record,\nrejection_status,\nincompletion_status_item,\nbilling_incompletion_status_item,\npricing_incompletion_status_item,\ndelivery_incompletion_status_item,\nconfirmed_quantity,\ncorrected_quantity,\ndelivery_date,\nschedule_line_category,\nloading_date,\nscheduled_line_blocked,\nrequired_quantity,\nmaterial_availability_date,\nbase_unit_of_measure,\ntransportation_planning_date,\nsales_unit,\ngoods_issue_date,\ndesired_delivery_date,\norder_quantity,\nquotation_valid_from,\norder_reason,\nquotation_valid_to,\ncompany_code,\nbilling_block_sd_document,\nlocal_currency,\nexchange_rate_type,\ncustomer_group_1,\ncustomer_group_2,\ncustomer_group_3,\ncustomer_group_4,\ncustomer_group_5,\ndelivery_block,\nstatistics_currency,\nsd_document_category_1,\nsales_office,\nsales_group,\nsales_organization,\ndistribution_channel,\nreason_for_rejection,\nchanged_on,\norder_probability,\nbatch_number,\ncredit_data_exchange_rate,\ninternational_article_number,\ncreated_on,\ncreated_by,\nbilling_block_item,\nweight_unit,\ncondition_unit,\ncondition_pricing_unit,\nstorage_location,\nmaterial_group,\nmaterial_entered,\nmaterial_group_1,\nmaterial_group_2,\nmaterial_group_3,\nmaterial_group_4,\nmaterial_group_5,\nnet_order_price,\nunloading_point_ship_to_party,\nbill_to_party,\npayer,\nship_to_party,\nproduct_hierarchy,\nforwarding_agent,\nitem_category,\nsales_employee,\nshipment_route,\ndivision,\nstatistics_date,\nexchange_rate_statistics,\nsubstitution_reason,\ndenominator,\nnumerator,\nconversion_factor_1,\nconversion_factor_2,\nupdate_date_statistics,\nsd_document_category_2,\nvolume_unit,\nshipping_point,\ndocument_currency_1,\ntarget_quantity_uom,\nsales_district,\nservices_rendered_date,\nbilling_date,\nincoterms_part_1,\nincoterms_part_2,\ncustomer_group,\naccount_assignment_group,\nexchange_rate,\ntranslation_date,\npricing_date,\ndocument_currency_2,\ndivision_for_order_header,\nsales_document_category_reference,\nwbs_element,\nfiscal_year_variant,\ncampaign_order_item,\nplanning_in_apo,\ncustomer_facing_location,\ncustomer_facing_location_type,\nexecuting_location,\nexecuting_location_type,\nlogical_system,\nitem_usage,\nmanaging_location,\nmanaging_location_type,\nsales_document_shipping,\npicking_confirmation,\npicking_status,\ngoods_movement_status,\nschedule_line_date,\nschedule_delivery_block,\ndelivered_quantity,\ngoods_issue_date_1,\ndesired_delete_date,\nunloading_point,\nincterms_1,\nincoterms_2,\nsold_to_party,\ndelivery_type,\nvendors_account_number,\nloading_point,\nroute,\nactual_goods_movement_date,\nentry_time,\nbusiness_area,\npicking_indicator,\nconsumption_posting,\nwarehouse_number,\nstorage_bin,\nstorage_type,\nitem_type,\ndelivery_item_category,\ndenominator_sales_quantity,\nnumerator_sales_quantity,\nsales_document_1,\nsales_document_item,\ngoods_issue_date_2,\ndivision_order_header,\ngoods_issue_delay,\nactual_goods_issue_delay,\nmaterial_key,\nplant_key,\ncustomer_sales_org_key,\nsupplier_key,\ncustomer_key,\nconfirmation_status,\nbilling_status_order_related,\nbilling_status_delivery_related,\noverall_processing_status,\noverall_deliver_status,\ndelivery_status,\ninput_last_update_date,\nfinalmd5key,\ndw_active_indicator,\ndw_start_date,\ndw_end_date,\ndw_last_update_date\n)\nVALUES \n(TO_HEX(MD5(scr.sales_order_key)),\nscr.sales_order_key,\nscr.sales_document,\nscr.item_number,\nscr.schedule_line_number,\nscr.sales_document_type,\nscr.material_uuid,\nscr.customer_uuid,\nscr.plant_uuid,\nscr.supplier_uuid,\nscr.customer_sales_org_uuid,\nscr.billing_block,\nscr.requested_delivery_date,\nscr.document_currency,\nscr.number_of_orders,\nscr.billing_block_1,\nscr.sd_document_category,\nscr.gross_weight,\nscr.application_component,\nscr.transfer_process,\nscr.billing_block_2,\nscr.cumulative_confirmed_quantity_sales_unit,\nscr.cumulative_confirmed_quantity_base_unit,\nscr.sales_deal,\nscr.cumulative_order_quantity,\nscr.subtotal_1,\nscr.subtotal_2,\nscr.subtotal_3,\nscr.subtotal_4,\nscr.subtotal_5,\nscr.subtotal_6,\nscr.minimum_delivery_quantity,\nscr.required_delivery_qtuantity,\nscr.tax_amount,\nscr.net_order_value,\nscr.net_weight,\nscr.special_stock_indicator,\nscr.unlimited_tolerance,\nscr.overdelivery_tolerance,\nscr.underdel_tolerance,\nscr.reference_document,\nscr.reference_item,\nscr.volume,\nscr.cost_in_document_currency,\nscr.target_quantity,\nscr.outline_agreement_target_value,\nscr.promotion,\nscr.product_catalog_number,\nscr.order_items,\nscr.net_price_sales_quantity,\nscr.cancel_data_record,\nscr.rejection_status,\nscr.incompletion_status_item,\nscr.billing_incompletion_status_item,\nscr.pricing_incompletion_status_item,\nscr.delivery_incompletion_status_item,\nscr.confirmed_quantity,\nscr.corrected_quantity,\nscr.delivery_date,\nscr.schedule_line_category,\nscr.loading_date,\nscr.scheduled_line_blocked,\nscr.required_quantity,\nscr.material_availability_date,\nscr.base_unit_of_measure,\nscr.transportation_planning_date,\nscr.sales_unit,\nscr.goods_issue_date,\nscr.desired_delivery_date,\nscr.order_quantity,\nscr.quotation_valid_from,\nscr.order_reason,\nscr.quotation_valid_to,\nscr.company_code,\nscr.billing_block_sd_document,\nscr.local_currency,\nscr.exchange_rate_type,\nscr.customer_group_1,\nscr.customer_group_2,\nscr.customer_group_3,\nscr.customer_group_4,\nscr.customer_group_5,\nscr.delivery_block,\nscr.statistics_currency,\nscr.sd_document_category_1,\nscr.sales_office,\nscr.sales_group,\nscr.sales_organization,\nscr.distribution_channel,\nscr.reason_for_rejection,\nscr.changed_on,\nscr.order_probability,\nscr.batch_number,\nscr.credit_data_exchange_rate,\nscr.international_article_number,\nscr.created_on,\nscr.created_by,\nscr.billing_block_item,\nscr.weight_unit,\nscr.condition_unit,\nscr.condition_pricing_unit,\nscr.storage_location,\nscr.material_group,\nscr.material_entered,\nscr.material_group_1,\nscr.material_group_2,\nscr.material_group_3,\nscr.material_group_4,\nscr.material_group_5,\nscr.net_order_price,\nscr.unloading_point_ship_to_party,\nscr.bill_to_party,\nscr.payer,\nscr.ship_to_party,\nscr.product_hierarchy,\nscr.forwarding_agent,\nscr.item_category,\nscr.sales_employee,\nscr.shipment_route,\nscr.division,\nscr.statistics_date,\nscr.exchange_rate_statistics,\nscr.substitution_reason,\nscr.denominator,\nscr.numerator,\nscr.conversion_factor_1,\nscr.conversion_factor_2,\nscr.update_date_statistics,\nscr.sd_document_category_2,\nscr.volume_unit,\nscr.shipping_point,\nscr.document_currency_1,\nscr.target_quantity_uom,\nscr.sales_district,\nscr.services_rendered_date,\nscr.billing_date,\nscr.incoterms_part_1,\nscr.incoterms_part_2,\nscr.customer_group,\nscr.account_assignment_group,\nscr.exchange_rate,\nscr.translation_date,\nscr.pricing_date,\nscr.document_currency_2,\nscr.division_for_order_header,\nscr.sales_document_category_reference,\nscr.wbs_element,\nscr.fiscal_year_variant,\nscr.campaign_order_item,\nscr.planning_in_apo,\nscr.customer_facing_location,\nscr.customer_facing_location_type,\nscr.executing_location,\nscr.executing_location_type,\nscr.logical_system,\nscr.item_usage,\nscr.managing_location,\nscr.managing_location_type,\nscr.sales_document_shipping,\nscr.picking_confirmation,\nscr.picking_status,\nscr.goods_movement_status,\nscr.schedule_line_date,\nscr.schedule_delivery_block,\nscr.delivered_quantity,\nscr.goods_issue_date_1,\nscr.desired_delete_date,\nscr.unloading_point,\nscr.incterms_1,\nscr.incoterms_2,\nscr.sold_to_party,\nscr.delivery_type,\nscr.vendors_account_number,\nscr.loading_point,\nscr.route,\nscr.actual_goods_movement_date,\nscr.entry_time,\nscr.business_area,\nscr.picking_indicator,\nscr.consumption_posting,\nscr.warehouse_number,\nscr.storage_bin,\nscr.storage_type,\nscr.item_type,\nscr.delivery_item_category,\nscr.denominator_sales_quantity,\nscr.numerator_sales_quantity,\nscr.sales_document_1,\nscr.sales_document_item,\nscr.goods_issue_date_2,\nscr.division_order_header,\nscr.goods_issue_delay,\nscr.actual_goods_issue_delay,\nscr.material_key,\nscr.plant_key,\nscr.customer_sale_org_key,\nscr.supplier_key,\nscr.customer_key,\nscr.confirmation_status,\nscr.billing_status_order_related,\nscr.billing_status_delivery_related,\nscr.overall_processing_status,\nscr.overall_deliver_status,\nscr.delivery_status,\nscr.input_last_update_date,\nscr.finalmd5key,\nscr.dw_active_indicator,\nCURRENT_DATETIME(),\nDATETIME(9999, 12, 31, 23, 59, 59),\nCURRENT_DATETIME()\n);",
                        "dialect": "standard",
                        "mode": "batch",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Merge-Statement"
            },
            {
                "name": "Update Audit Table",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Update Audit Table",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.18.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO \n`${ProjectID}.${StagingDatasetName}.layer1_audit_table` tgt\nUSING ( SELECT \n         'sales_order_fact' as table_name\n         ,CASE WHEN (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'sales_order_fact') IS NULL\n                    OR (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'sales_order_fact') = 'F'\n               THEN 'F'\n               ELSE 'D'\n          END AS full_delta_indicator\n        ,'2LIS_11_VAHDR,2LIS_11_VAITM,2LIS_11_VASCL,2LIS_11_VASTI,2LIS_11_VASTH,2LIS_12_VCSCL' as extractors_names\n        ,CAST('1900-01-01T00:00:00' AS DATETIME) as full_load_datetime\n        ,(select max(input_last_update_date) as delta_load_datatime from `${ProjectID}.${TargetDatasetNames2}.sales_order_fact`) as delta_load_datetime\n        ,(select COUNT(*) AS inserted_record_count from `${ProjectID}.${TargetDatasetNames2}.sales_order_fact` a inner join `${ProjectID}.${StagingDatasetName}.layer1_audit_table` b\n          on 1 = 1 where b.table_name = 'sales_order_fact' and  a.dw_last_update_date > CASE WHEN b.full_delta_indicator = 'F' \n                                                                                             THEN b.full_load_datetime\n                                                                                             WHEN b.full_delta_indicator <> 'F'\n                                                                                             THEN b.delta_load_datetime\n                                                                                             ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                                                                        END\n          and a.dw_active_indicator = 'Y') AS inserted_record_count\n        ,CURRENT_DATETIME() as last_update_date\n) scr\non tgt.table_name = scr.table_name\nWHEN MATCHED THEN \nUPDATE set tgt.full_load_datetime ='1900-01-01T00:00:00'\n          ,tgt.delta_load_datetime = scr.delta_load_datetime\n          ,tgt.inserted_record_count = scr.inserted_record_count\n          ,tgt.last_update_date = scr.last_update_date\nWHEN NOT MATCHED THEN\nINSERT (table_name,\n        full_delta_indicator,\n        extractors_names,\n        full_load_datetime,\n        delta_load_datetime,\n        inserted_record_count,\n        last_update_date)\nVALUES(scr.table_name,\n       scr.full_delta_indicator,\n       scr.extractors_names,\n       scr.full_load_datetime,\n       scr.delta_load_datetime,\n       scr.inserted_record_count,\n       scr.last_update_date);",
                        "dialect": "standard",
                        "mode": "batch",
                        "dataset": "${StagingDatasetName}",
                        "table": "layer1_audit_table",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Update-Audit-Table"
            }
        ],
        "schedule": "0 * * * *",
        "engine": "spark",
        "numOfRecordsPreview": 100,
        "description": "sales order fact",
        "maxConcurrentRuns": 1
    }
}