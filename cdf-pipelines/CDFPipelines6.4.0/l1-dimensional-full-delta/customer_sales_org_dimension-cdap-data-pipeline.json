{
    "name": "customer_sales_org_dimension",
    "description": "customer sales org dimension",
    "artifact": {
        "name": "cdap-data-pipeline",
        "version": "6.4.0",
        "scope": "SYSTEM"
    },
    "config": {
        "resources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "driverResources": {
            "memoryMB": 2048,
            "virtualCores": 1
        },
        "connections": [
            {
                "from": "Merge Statement",
                "to": "Update Audit Table"
            }
        ],
        "comments": [],
        "postActions": [],
        "properties": {},
        "processTimingEnabled": true,
        "stageLoggingEnabled": false,
        "stages": [
            {
                "name": "Merge Statement",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Merge Statement",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.17.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO\n  `${ProjectID}.${TargetDatasetNames2}.customer_sales_org_dimension` tgt\nUSING\n  (\nWITH tmp_scr AS (  SELECT\n    (cm.customer_number || '-' || csd.sales_organization || '-' || csd.distribution_channel || '-' || csd.division) as customer_sales_org_key,\n    cm.customer_number,\n    csd.sales_organization,\n    csd.distribution_channel,\n    csd.division,\n    cm.customer_classification,\n    cm.industry_key,\n    cm.country_key,\n    cm.address,\n    cm.title,\n    cm.central_order_block,\n    cm.express_station,\n    cm.train_station,\n    cm.international_location_number_1,\n    cm.international_location_number_2,\n    cm.authorization_group,\n    cm.check_digit,\n    cm.data_line,\n    cm.unloading_points,\n    cm.fiscal_address,\n    cm.working_times,\n    cm.alternative_payer,\n    cm.group_key,\n    cm.customer_account_group,\n    cm.vendors_account_number,\n    cm.central_delivery_block,\n    cm.location_code,\n    cm.central_deletion_flag,\n    cm.name_1,\n    cm.name_2,\n    cm.name_3,\n    cm.name_4,\n    cm.nielsen_indicator,\n    cm.city,\n    cm.district,\n    cm.post_office_box,\n    cm.po_box_postal_code,\n    cm.postal_code,\n    cm.region,\n    cm.county_code,\n    cm.city_code,\n    cm.regional_market,\n    cm.sort_field,\n    cm.central_posting_block,\n    cm.language_key,\n    cm.tax_number_1,\n    cm.tax_number_2,\n    cm.sales_equalization_tax,\n    cm.liable_for_vat,\n    cm.street_and_house_number,\n    cm.telebox_number,\n    cm.telephone_1,\n    cm.telephone_2,\n    cm.fax_number,\n    cm.teletex_number,\n    cm.telex_number,\n    cm.transportation_zone,\n    cm.one_time_account,\n    cm.payee_in_document,\n    cm.trading_partner,\n    cm.vat_registration_number,\n    cm.competitors_indicator,\n    cm.sales_partners_indicator,\n    cm.sales_prospect_indicator,\n    cm.customer_type_4,\n    cm.default_sold_to_party,\n    cm.consumer_indicator,\n    cm.legal_status,\n    cm.industry_code_1,\n    cm.industry_code_2,\n    cm.industry_code_3,\n    cm.industry_code_4,\n    cm.industry_code_5,\n    cm.initial_contact,\n    cm.annual_sales_2,\n    cm.sales_year,\n    cm.currency_sales_figure,\n    cm.year_number_employees,\n    cm.year_number_given,\n    cm.attribute_1,\n    cm.attribute_2,\n    cm.attribute_3,\n    cm.attribute_4,\n    cm.attribute_5,\n    cm.attribute_6,\n    cm.attribute_7,\n    cm.attribute_8,\n    cm.attribute_9,\n    cm.attribute_10,\n    cm.natural_person,\n    cm.annual_sales_1,\n    cm.tax_jurisdiction,\n    cm.matchcode_name_1,\n    cm.matchcode_name_2,\n    cm.matcgcode_city,\n    cm.fiscal_year_variant,\n    cm.usage_indicator,\n    cm.by_customer,\n    cm.after_delivery,\n    cm.reference_account_group,\n    cm.post_office_box_city,\n    cm.plant,\n    cm.date_medium_exchange_indicator,\n    cm.instruction_key,\n    cm.data_transfer_status,\n    cm.hierarchy_assignment,\n    cm.payment_block,\n    cm.labeking_customer_group,\n    cm.non_military_use,\n    cm.military_use,\n    cm.condition_group_1,\n    cm.condition_group_2,\n    cm.condition_group_3,\n    cm.condition_group_4,\n    cm.condition_group_5,\n    cm.alternative_payer_account,\n    cm.tax_type,\n    cm.tax_number_type,\n    cm.tax_number_3,\n    cm.tax_number_4,\n    cm.icms_exempt,\n    cm.ipi_exempt,\n    cm.subtrib_group,\n    cm.customer_cfop_category,\n    cm.icms_law,\n    cm.ipi_law,\n    cm.biochemical_warfare,\n    cm.nuclear_nonprolif,\n    cm.national_security,\n    cm.missile_technology,\n    cm.central_sales_block,\n    cm.uniform_resource_locator,\n    csd.created_by,\n    csd.created_on,\n    csd.deletion_indicator_sales_area,\n    csd.customer_statistics_group,\n    csd.order_block_sales_area,\n    csd.customer_price_procedure,\n    csd.customer_group,\n    csd.sales_district,\n    csd.customer_price_group,\n    csd.price_list_type,\n    csd.order_probability,\n    csd.incoterms_part_1,\n    csd.incoterms_part_2,\n    csd.delivery_block_sales_area,\n    csd.complete_delivery,\n    csd.maximum_partial_deliveries,\n    csd.partial_delivery,\n    csd.order_combination_indicator,\n    csd.batch_split_allowed,\n    csd.delivery_priority,\n    csd.account_at_customer,\n    csd.shipping_conditions,\n    csd.central_billing_block,\n    csd.manual_invoice_maintenance,\n    csd.invoicing_dates,\n    csd.invoice_list_schedule,\n    csd.cost_estimate,\n    csd.maximum_cost_estimate,\n    csd.currency_key,\n    csd.abc_classification,\n    csd.account_assignment_group,\n    csd.delivering_plant,\n    csd.sales_group,\n    csd.sales_office,\n    csd.item_proposal,\n    csd.customer_group_1,\n    csd.customer_group_2,\n    csd.customer_group_3,\n    csd.customer_group_4,\n    csd.customer_group_5,\n    csd.rebate_relevant,\n    csd.rebate_index,\n    csd.exchange_rate_type,\n    csd.price_determination,\n    csd.product_attribute_1,\n    csd.product_attribute_2,\n    csd.product_attribute_3,\n    csd.product_attribute_4,\n    csd.product_attribute_5,\n    csd.product_attribute_6,\n    csd.product_attribute_7,\n    csd.product_attribute_8,\n    csd.product_attribute_9,\n    csd.product_attribute_10,\n    csd.payment_terms,\n    CASE WHEN cm.dw_last_update_date > csd.dw_last_update_date \n         THEN cm.dw_last_update_date\n         ELSE csd.dw_last_update_date\n    END AS input_last_update_date,\n    csd.dw_active_indicator\n  FROM `${ProjectID}.${StagingDatasetName}.customer_master` cm\n       INNER JOIN `${ProjectID}.${StagingDatasetName}.customer_sales_data` csd\n    ON cm.customer_number = csd.customer_number\n       INNER JOIN `${ProjectID}.${StagingDatasetName}.layer1_audit_table` lat\n    ON 1 = 1\n   AND lat.table_name = 'customer_sales_org_dimension'\n WHERE cm.dw_active_indicator = 'Y'\n   AND (cm.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' THEN lat.full_load_datetime\n                                            WHEN lat.full_delta_indicator <> 'F' THEN lat.delta_load_datetime\n                                            ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                       END\n    OR cm.dw_last_update_date >= CASE WHEN lat.full_delta_indicator = 'F' THEN lat.full_load_datetime\n                                            WHEN lat.full_delta_indicator <> 'F' THEN lat.delta_load_datetime\n                                            ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                       END)),\n  tmp_cust AS (SELECT ts.*,\n     TO_HEX(MD5((select string_agg(CAST(col as STRING), ', ' order by offset)\n    from unnest(split(trim(format('%t',(select as struct ts.* except(input_last_update_date))), '()'),', ')) col with offset \n    where not col IS NULL\n    ))) as finalmd5key      \n  from tmp_scr ts)\nSELECT t.customer_sales_org_key as customer_sales_org_join_key,t.*\n  from tmp_cust t\nUNION ALL \nSELECT NULL as customer_sales_org_join_key,t.*\n  from tmp_cust t\n      INNER JOIN `${ProjectID}.${TargetDatasetNames2}.customer_sales_org_dimension` csod\n    ON csod.customer_sales_org_key = t.customer_sales_org_key\n AND csod.finalmd5key <> t.finalmd5key\nWHERE csod.dw_active_indicator = 'Y') scr\nON  scr.customer_sales_org_join_key = tgt.customer_sales_org_key\nWHEN MATCHED AND tgt.finalmd5key <> scr.finalmd5key THEN\nUPDATE set tgt.dw_end_date = CURRENT_DATETIME()\n          ,tgt.dw_active_indicator = 'N'\nWHEN NOT MATCHED THEN\nINSERT (\ncustomer_sales_org_uuid,\ncustomer_sales_org_key,\ncustomer_number,\nsales_organization,\ndistribution_channel,\ndivision,\ncustomer_classification,\nindustry_key,\ncountry_key,\naddress,\ntitle,\ncentral_order_block,\nexpress_station,\ntrain_station,\ninternational_location_number_1,\ninternational_location_number_2,\nauthorization_group,\ncheck_digit,\ndata_line,\nunloading_points,\nfiscal_address,\nworking_times,\nalternative_payer,\ngroup_key,\ncustomer_account_group,\nvendors_account_number,\ncentral_delivery_block,\nlocation_code,\ncentral_deletion_flag,\nname_1,\nname_2,\nname_3,\nname_4,\nnielsen_indicator,\ncity,\ndistrict,\npost_office_box,\npo_box_postal_code,\npostal_code,\nregion,\ncounty_code,\ncity_code,\nregional_market,\nsort_field,\ncentral_posting_block,\nlanguage_key,\ntax_number_1,\ntax_number_2,\nsales_equalization_tax,\nliable_for_vat,\nstreet_and_house_number,\ntelebox_number,\ntelephone_1,\ntelephone_2,\nfax_number,\nteletex_number,\ntelex_number,\ntransportation_zone,\none_time_account,\npayee_in_document,\ntrading_partner,\nvat_registration_number,\ncompetitors_indicator,\nsales_partners_indicator,\nsales_prospect_indicator,\ncustomer_type_4,\ndefault_sold_to_party,\nconsumer_indicator,\nlegal_status,\nindustry_code_1,\nindustry_code_2,\nindustry_code_3,\nindustry_code_4,\nindustry_code_5,\ninitial_contact,\nannual_sales_2,\nsales_year,\ncurrency_sales_figure,\nyear_number_employees,\nyear_number_given,\nattribute_1,\nattribute_2,\nattribute_3,\nattribute_4,\nattribute_5,\nattribute_6,\nattribute_7,\nattribute_8,\nattribute_9,\nattribute_10,\nnatural_person,\nannual_sales_1,\ntax_jurisdiction,\nmatchcode_name_1,\nmatchcode_name_2,\nmatcgcode_city,\nfiscal_year_variant,\nusage_indicator,\nby_customer,\nafter_delivery,\nreference_account_group,\npost_office_box_city,\nplant,\ndate_medium_exchange_indicator,\ninstruction_key,\ndata_transfer_status,\nhierarchy_assignment,\npayment_block,\nlabeking_customer_group,\nnon_military_use,\nmilitary_use,\ncondition_group_1,\ncondition_group_2,\ncondition_group_3,\ncondition_group_4,\ncondition_group_5,\nalternative_payer_account,\ntax_type,\ntax_number_type,\ntax_number_3,\ntax_number_4,\nicms_exempt,\nipi_exempt,\nsubtrib_group,\ncustomer_cfop_category,\nicms_law,\nipi_law,\nbiochemical_warfare,\nnuclear_nonprolif,\nnational_security,\nmissile_technology,\ncentral_sales_block,\nuniform_resource_locator,\ncreated_by,\ncreated_on,\ndeletion_indicator_sales_area,\ncustomer_statistics_group,\norder_block_sales_area,\ncustomer_price_procedure,\ncustomer_group,\nsales_district,\ncustomer_price_group,\nprice_list_type,\norder_probability,\nincoterms_part_1,\nincoterms_part_2,\ndelivery_block_sales_area,\ncomplete_delivery,\nmaximum_partial_deliveries,\npartial_delivery,\norder_combination_indicator,\nbatch_split_allowed,\ndelivery_priority,\naccount_at_customer,\nshipping_conditions,\ncentral_billing_block,\nmanual_invoice_maintenance,\ninvoicing_dates,\ninvoice_list_schedule,\ncost_estimate,\nmaximum_cost_estimate,\ncurrency_key,\nabc_classification,\naccount_assignment_group,\ndelivering_plant,\nsales_group,\nsales_office,\nitem_proposal,\ncustomer_group_1,\ncustomer_group_2,\ncustomer_group_3,\ncustomer_group_4,\ncustomer_group_5,\nrebate_relevant,\nrebate_index,\nexchange_rate_type,\nprice_determination,\nproduct_attribute_1,\nproduct_attribute_2,\nproduct_attribute_3,\nproduct_attribute_4,\nproduct_attribute_5,\nproduct_attribute_6,\nproduct_attribute_7,\nproduct_attribute_8,\nproduct_attribute_9,\nproduct_attribute_10,\npayment_terms,\ninput_last_update_date,\nfinalmd5key,\ndw_active_indicator,\ndw_start_date,\ndw_end_date,\ndw_last_update_date\n)\nVALUES(\nTO_HEX(MD5(customer_sales_org_key)),\nscr.customer_sales_org_key,\nscr.customer_number,\nscr.sales_organization,\nscr.distribution_channel,\nscr.division,\nscr.customer_classification,\nscr.industry_key,\nscr.country_key,\nscr.address,\nscr.title,\nscr.central_order_block,\nscr.express_station,\nscr.train_station,\nscr.international_location_number_1,\nscr.international_location_number_2,\nscr.authorization_group,\nscr.check_digit,\nscr.data_line,\nscr.unloading_points,\nscr.fiscal_address,\nscr.working_times,\nscr.alternative_payer,\nscr.group_key,\nscr.customer_account_group,\nscr.vendors_account_number,\nscr.central_delivery_block,\nscr.location_code,\nscr.central_deletion_flag,\nscr.name_1,\nscr.name_2,\nscr.name_3,\nscr.name_4,\nscr.nielsen_indicator,\nscr.city,\nscr.district,\nscr.post_office_box,\nscr.po_box_postal_code,\nscr.postal_code,\nscr.region,\nscr.county_code,\nscr.city_code,\nscr.regional_market,\nscr.sort_field,\nscr.central_posting_block,\nscr.language_key,\nscr.tax_number_1,\nscr.tax_number_2,\nscr.sales_equalization_tax,\nscr.liable_for_vat,\nscr.street_and_house_number,\nscr.telebox_number,\nscr.telephone_1,\nscr.telephone_2,\nscr.fax_number,\nscr.teletex_number,\nscr.telex_number,\nscr.transportation_zone,\nscr.one_time_account,\nscr.payee_in_document,\nscr.trading_partner,\nscr.vat_registration_number,\nscr.competitors_indicator,\nscr.sales_partners_indicator,\nscr.sales_prospect_indicator,\nscr.customer_type_4,\nscr.default_sold_to_party,\nscr.consumer_indicator,\nscr.legal_status,\nscr.industry_code_1,\nscr.industry_code_2,\nscr.industry_code_3,\nscr.industry_code_4,\nscr.industry_code_5,\nscr.initial_contact,\nscr.annual_sales_2,\nscr.sales_year,\nscr.currency_sales_figure,\nscr.year_number_employees,\nscr.year_number_given,\nscr.attribute_1,\nscr.attribute_2,\nscr.attribute_3,\nscr.attribute_4,\nscr.attribute_5,\nscr.attribute_6,\nscr.attribute_7,\nscr.attribute_8,\nscr.attribute_9,\nscr.attribute_10,\nscr.natural_person,\nscr.annual_sales_1,\nscr.tax_jurisdiction,\nscr.matchcode_name_1,\nscr.matchcode_name_2,\nscr.matcgcode_city,\nscr.fiscal_year_variant,\nscr.usage_indicator,\nscr.by_customer,\nscr.after_delivery,\nscr.reference_account_group,\nscr.post_office_box_city,\nscr.plant,\nscr.date_medium_exchange_indicator,\nscr.instruction_key,\nscr.data_transfer_status,\nscr.hierarchy_assignment,\nscr.payment_block,\nscr.labeking_customer_group,\nscr.non_military_use,\nscr.military_use,\nscr.condition_group_1,\nscr.condition_group_2,\nscr.condition_group_3,\nscr.condition_group_4,\nscr.condition_group_5,\nscr.alternative_payer_account,\nscr.tax_type,\nscr.tax_number_type,\nscr.tax_number_3,\nscr.tax_number_4,\nscr.icms_exempt,\nscr.ipi_exempt,\nscr.subtrib_group,\nscr.customer_cfop_category,\nscr.icms_law,\nscr.ipi_law,\nscr.biochemical_warfare,\nscr.nuclear_nonprolif,\nscr.national_security,\nscr.missile_technology,\nscr.central_sales_block,\nscr.uniform_resource_locator,\nscr.created_by,\nscr.created_on,\nscr.deletion_indicator_sales_area,\nscr.customer_statistics_group,\nscr.order_block_sales_area,\nscr.customer_price_procedure,\nscr.customer_group,\nscr.sales_district,\nscr.customer_price_group,\nscr.price_list_type,\nscr.order_probability,\nscr.incoterms_part_1,\nscr.incoterms_part_2,\nscr.delivery_block_sales_area,\nscr.complete_delivery,\nscr.maximum_partial_deliveries,\nscr.partial_delivery,\nscr.order_combination_indicator,\nscr.batch_split_allowed,\nscr.delivery_priority,\nscr.account_at_customer,\nscr.shipping_conditions,\nscr.central_billing_block,\nscr.manual_invoice_maintenance,\nscr.invoicing_dates,\nscr.invoice_list_schedule,\nscr.cost_estimate,\nscr.maximum_cost_estimate,\nscr.currency_key,\nscr.abc_classification,\nscr.account_assignment_group,\nscr.delivering_plant,\nscr.sales_group,\nscr.sales_office,\nscr.item_proposal,\nscr.customer_group_1,\nscr.customer_group_2,\nscr.customer_group_3,\nscr.customer_group_4,\nscr.customer_group_5,\nscr.rebate_relevant,\nscr.rebate_index,\nscr.exchange_rate_type,\nscr.price_determination,\nscr.product_attribute_1,\nscr.product_attribute_2,\nscr.product_attribute_3,\nscr.product_attribute_4,\nscr.product_attribute_5,\nscr.product_attribute_6,\nscr.product_attribute_7,\nscr.product_attribute_8,\nscr.product_attribute_9,\nscr.product_attribute_10,\nscr.payment_terms,\nscr.input_last_update_date,\nscr.finalmd5key,\nscr.dw_active_indicator,\nCURRENT_DATETIME(),\nDATETIME(9999, 12, 31, 23, 59, 59),\nCURRENT_DATETIME());",
                        "dialect": "standard",
                        "mode": "batch",
                        "dataset": "${TargetDatasetNames2}",
                        "table": "customer_sales_org_dimension",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Merge-Statement",
                "type": "action",
                "label": "Merge Statement",
                "icon": "fa-plug"
            },
            {
                "name": "Update Audit Table",
                "plugin": {
                    "name": "BigQueryExecute",
                    "type": "action",
                    "label": "Update Audit Table",
                    "artifact": {
                        "name": "google-cloud",
                        "version": "0.17.0",
                        "scope": "SYSTEM"
                    },
                    "properties": {
                        "project": "auto-detect",
                        "sql": "MERGE INTO\n`${ProjectID}.${StagingDatasetName}.layer1_audit_table` tgt\nUSING ( SELECT \n         'customer_sales_org_dimension' as table_name\n         ,CASE WHEN (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'customer_sales_org_dimension') IS NULL\n                    OR (select full_delta_indicator from `${ProjectID}.${StagingDatasetName}.layer1_audit_table` where table_name = 'customer_sales_org_dimension') = 'F'\n               THEN 'F'\n               ELSE 'D'\n          END AS full_delta_indicator\n        ,'0CUSTOMER_ATTR,0CUST_SALES_ATTR,0BP_DEF_ADDRESS_ATTR' as extractors_names\n        ,CAST('1900-01-01T00:00:00' AS DATETIME) as full_load_datetime\n        ,(select max(input_last_update_date) as delta_load_datatime from `${ProjectID}.${TargetDatasetNames2}.customer_sales_org_dimension`) as delta_load_datetime\n        ,(select COUNT(*) AS inserted_record_count from `${ProjectID}.${TargetDatasetNames2}.customer_sales_org_dimension` a inner join `${ProjectID}.${StagingDatasetName}.layer1_audit_table` b\n          on 1 = 1 where b.table_name = 'customer_sales_org_dimension' and  a.dw_last_update_date > CASE WHEN b.full_delta_indicator = 'F' \n                                                                                            THEN b.full_load_datetime\n                                                                                            WHEN b.full_delta_indicator <> 'F' THEN b.delta_load_datetime\n                                                                                            ELSE CAST('1900-01-01T00:00:00' AS DATETIME)\n                                                                                       END\n          and a.dw_active_indicator = 'Y') AS inserted_record_count\n        ,CURRENT_DATETIME() as last_update_date\n) scr\non tgt.table_name = scr.table_name\nWHEN MATCHED THEN \nUPDATE set tgt.full_load_datetime ='1900-01-01T00:00:00'\n          ,tgt.delta_load_datetime = scr.delta_load_datetime\n          ,tgt.inserted_record_count = scr.inserted_record_count\n          ,tgt.last_update_date = scr.last_update_date\n          ,tgt.extractors_names = scr.extractors_names\nWHEN NOT MATCHED THEN\nINSERT (table_name,\n        full_delta_indicator,\n        extractors_names,\n        full_load_datetime,\n        delta_load_datetime,\n        inserted_record_count,\n        last_update_date)\nVALUES(scr.table_name,\n       scr.full_delta_indicator,\n       scr.extractors_names,\n       scr.full_load_datetime,\n       scr.delta_load_datetime,\n       scr.inserted_record_count,\n       scr.last_update_date);",
                        "dialect": "standard",
                        "mode": "batch",
                        "dataset": "${StagingDatasetName}",
                        "table": "layer1_audit_table",
                        "useCache": "false",
                        "location": "US",
                        "rowAsArguments": "false",
                        "serviceAccountType": "filePath",
                        "serviceFilePath": "auto-detect"
                    }
                },
                "outputSchema": [
                    {
                        "name": "etlSchemaBody",
                        "schema": ""
                    }
                ],
                "id": "Update-Audit-Table",
                "type": "action",
                "label": "Update Audit Table",
                "icon": "fa-plug"
            }
        ],
        "schedule": "0 * * * *",
        "engine": "spark",
        "numOfRecordsPreview": 100,
        "description": "customer sales org dimension",
        "maxConcurrentRuns": 1
    }
}